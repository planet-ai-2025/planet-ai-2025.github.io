<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basic Convolution Animation</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121820;
      --panel-2: #0f141b;
      --text: #e8f0ff;
      --muted: #a9b4c2;
      --accent: #6ea8fe;
      --accent-2: #7ef0c1;
      --grid: #233042;
      --highlight: #ffcb6b;
      --danger: #ff6b6b;
      --ok: #7ef0c1;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% -10%, #152233 0, #0b0f14 50%);
      color: var(--text);
    }

    h1 { font-size: 22px; margin: 0 0 12px; letter-spacing: .2px; }
    p { color: var(--muted); margin: 0 0 16px; }

    .app {
      display: grid; grid-template-columns: 340px 1fr; gap: 16px;
      max-width: 1200px; margin: 0 auto;
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid #1c2633; border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .controls { display: grid; gap: 12px; align-content: start; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row label { font-size: 13px; color: var(--muted); }

    button {
      background: #1b2431; color: var(--text);
      border: 1px solid #263347; border-radius: 12px; padding: 10px 14px;
      cursor: pointer; font-weight: 600; letter-spacing: .2px;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { background: #223149; }
    button:active { transform: translateY(1px); }
    .primary { background: linear-gradient(180deg, #2a3c57, #223149); border-color: #314666; }
    .danger { background: linear-gradient(180deg, #5b2b2b, #3b1e1e); border-color: #6b2e2e; }

    input[type="number"] {
      width: 64px; padding: 8px 10px; border-radius: 10px;
      border: 1px solid #2a3951; background: #0f1420; color: var(--text);
    }

    input[type="range"] { width: 160px; }

    .grids {
      display: grid; grid-template-columns: 1fr 240px 1fr; gap: 16px; align-items: start;
    }

    .grid-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--muted); margin-bottom: 8px; }

    .grid {
      display: grid; gap: 4px; padding: 10px; background: #0e151f; border-radius: 12px; border: 1px solid #1c2633;
    }

    .cell {
      width: 44px; height: 44px; display: grid; place-items: center;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--grid); border-radius: 8px;
      font-weight: 700; color: #d7e3ff; user-select: none;
      position: relative; overflow: hidden;
    }
    .cell.small { width: 40px; height: 40px; font-weight: 600; font-size: 13px; }

    .cell.highlight::after { content: ""; position: absolute; inset: 0; border: 2px solid var(--highlight); border-radius: 10px; box-shadow: 0 0 0 2px rgba(255,203,107,.15) inset; }

    .cell.out { background: rgba(126,240,193,0.07); }

    .legend { font-size: 12px; color: var(--muted); margin-top: 10px; display: grid; gap: 6px; }
    .legend .tag { display: inline-grid; grid-auto-flow: column; gap: 8px; align-items: center; }
    .swatch {
      inline-size: 14px; block-size: 14px; border-radius: 4px; display: inline-block;
      border: 2px solid var(--highlight); background: rgba(255,203,107,.15);
    }

    .math {
      margin-top: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #0f1622; border-radius: 10px; border: 1px solid #1c2633; padding: 10px;
      color: #c9d7ff; font-size: 13px; line-height: 1.5;
      white-space: pre-wrap;
    }

    .kernel-editor { display: grid; gap: 6px; }
    .kernel-editor .cell:hover { outline: 2px dashed #314666; cursor: text; }
    .kernel-editor input[type="number"] { width: 56px; text-align: center; }

    .center { display: grid; place-items: center; }

    .spacer { height: 4px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card controls">
      <h1>Basic Convolution Animation</h1>
      <p>Watch a 3×3 kernel slide across a 2D input with stride 1 and no padding. The output is filled cell by cell with the dot‑product.</p>

      <div class="row">
        <button id="play" class="primary">▶ Play</button>
        <button id="step">⏭ Step</button>
        <button id="reset" class="danger">⟲ Reset</button>
      </div>

      <div class="row">
        <label for="speed">Speed</label>
        <input id="speed" type="range" min="0" max="1000" value="500" />
        <span id="speedLabel" aria-live="polite">500 ms/step</span>
      </div>

      <div class="row">
        <label>Kernel (editable):</label>
      </div>
      <div id="kernelEditor" class="grid kernel-editor" style="grid-template-columns: repeat(3, 1fr);"></div>

      <div class="legend">
        <span class="tag"><span class="swatch"></span> Current receptive field</span>
        <span>Dot product shown below as it’s computed.</span>
      </div>

      <div class="math" id="mathBox">Press Play or Step to start.</div>
    </div>

    <div class="card">
      <div class="grids">
        <div>
          <div class="grid-title">Input (5×5)</div>
          <div id="inputGrid" class="grid"></div>
        </div>
        <div class="center" aria-hidden="true">→</div>
        <div>
          <div class="grid-title">Output (3×3)</div>
          <div id="outputGrid" class="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----- Data -----
    const INPUT_SIZE = 5;
    const K = 3; // kernel size
    const STRIDE = 1;

    // Preset input for determinism (0..9 values). Feel free to change.
    const input = [
      [2, 3, 1, 0, 2],
      [0, 1, 4, 2, 1],
      [3, 2, 1, 0, 1],
      [2, 1, 0, 1, 3],
      [0, 2, 2, 3, 1]
    ];

    let kernel = [
      [1, 0, -1],
      [1, 0, -1],
      [1, 0, -1]
    ];

    const OUTPUT_SIZE = Math.floor((INPUT_SIZE - K) / STRIDE) + 1; // 3
    const output = Array.from({ length: OUTPUT_SIZE }, () => Array(OUTPUT_SIZE).fill(null));

    // ----- DOM helpers -----
    const $ = (id) => document.getElementById(id);
    const inputGrid = $("inputGrid");
    const outputGrid = $("outputGrid");
    const kernelEditor = $("kernelEditor");
    const mathBox = $("mathBox");

    function renderGrid(el, size, values, { small=false } = {}) {
      el.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      el.innerHTML = '';
      for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell' + (small ? ' small' : '');
          const v = values?.[r]?.[c];
          cell.textContent = v === null || v === undefined ? '' : v;
          el.appendChild(cell);
        }
      }
    }

    function highlightWindow(r, c) {
      // Remove previous highlights
      [...inputGrid.children].forEach((child) => child.classList.remove('highlight'));
      for (let i = 0; i < K; i++) {
        for (let j = 0; j < K; j++) {
          const rr = r + i; const cc = c + j;
          const idx = rr * INPUT_SIZE + cc;
          const cell = inputGrid.children[idx];
          if (cell) cell.classList.add('highlight');
        }
      }
    }

    function setOutputCell(r, c, value) {
      const idx = r * OUTPUT_SIZE + c;
      const cell = outputGrid.children[idx];
      if (cell) {
        cell.classList.add('out');
        cell.textContent = value;
      }
    }

    function renderKernelEditor() {
      kernelEditor.innerHTML = '';
      for (let r = 0; r < K; r++) {
        for (let c = 0; c < K; c++) {
          const inputEl = document.createElement('input');
          inputEl.type = 'number';
          inputEl.value = kernel[r][c];
          inputEl.step = '1';
          inputEl.addEventListener('change', () => {
            kernel[r][c] = Number(inputEl.value);
          });
          kernelEditor.appendChild(inputEl);
        }
      }
    }

    // ----- Convolution logic -----
    function dotAt(r, c) {
      let sum = 0;
      const terms = [];
      for (let i = 0; i < K; i++) {
        for (let j = 0; j < K; j++) {
          const a = input[r + i][c + j];
          const b = kernel[i][j];
          sum += a * b;
          terms.push(`${a}×${b}`);
        }
      }
      return { sum, expr: terms.join(' + ') };
    }

    function* scanPositions() {
      for (let r = 0; r <= INPUT_SIZE - K; r += STRIDE) {
        for (let c = 0; c <= INPUT_SIZE - K; c += STRIDE) {
          yield [r, c];
        }
      }
    }

    // ----- Animation state -----
    let playing = false;
    let timer = null;
    let iterator = scanPositions();

    function updateSpeedLabel() {
      const ms = Number($("speed").value);
      $("speedLabel").textContent = `${ms} ms/step`;
      if (playing) startTimer();
    }

    function startTimer() {
      stopTimer();
      const ms = Number($("speed").value);
      timer = setInterval(stepOnce, ms);
    }

    function stopTimer() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    function playPause() {
      playing = !playing;
      $("play").textContent = playing ? '⏸ Pause' : '▶ Play';
      if (playing) startTimer(); else stopTimer();
    }

    function resetAll() {
      stopTimer(); playing = false; $("play").textContent = '▶ Play';
      for (let r = 0; r < OUTPUT_SIZE; r++) for (let c = 0; c < OUTPUT_SIZE; c++) output[r][c] = null;
      renderGrid(outputGrid, OUTPUT_SIZE, output, { small: false });
      iterator = scanPositions();
      [...inputGrid.children].forEach((child) => child.classList.remove('highlight'));
      mathBox.textContent = 'Press Play or Step to start.';
    }

    function stepOnce() {
      const next = iterator.next();
      if (next.done) { stopTimer(); playing = false; $("play").textContent = '▶ Play'; return; }
      const [r, c] = next.value;
      highlightWindow(r, c);
      const { sum, expr } = dotAt(r, c);
      setOutputCell(r, c, sum);
      mathBox.textContent = `y[${r},${c}] = ${expr} = ${sum}`;
    }

    // ----- Init -----
    function init() {
      renderGrid(inputGrid, INPUT_SIZE, input, { small: false });
      renderGrid(outputGrid, OUTPUT_SIZE, output, { small: false });
      renderKernelEditor();

      $("play").addEventListener('click', playPause);
      $("step").addEventListener('click', stepOnce);
      $("reset").addEventListener('click', resetAll);
      $("speed").addEventListener('input', updateSpeedLabel);
      updateSpeedLabel();
    }

    init();
  </script>
</body>
</html>